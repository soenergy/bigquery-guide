<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Contact Flow - Sankey Diagram</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0d0d0d 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            color: #888;
            font-size: 1rem;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-group label {
            color: #aaa;
            font-size: 0.9rem;
        }
        input[type="date"] {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .stat-label {
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card.cyan .stat-value { color: #00d4ff; }
        .stat-card.purple .stat-value { color: #7c3aed; }
        .stat-card.green .stat-value { color: #10b981; }
        .stat-card.yellow .stat-value { color: #f59e0b; }
        .stat-card.red .stat-value { color: #ef4444; }
        .stat-card.blue .stat-value { color: #3b82f6; }
        #sankey-chart {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            min-height: 600px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #aaa;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .insight-box {
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }
        .insight-box h3 {
            color: #7c3aed;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .insight-box p {
            color: #aaa;
            font-size: 0.85rem;
        }
        .data-note {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 0.8rem;
        }
        footer {
            text-align: center;
            padding: 30px 0;
            color: #555;
            font-size: 0.8rem;
            margin-top: 30px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Chatbot Contact Flow</h1>
            <p class="subtitle">CHAT Channel - Bot & Agent Journey Analysis</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label for="report-date">Report Date:</label>
                <input type="date" id="report-date" value="2025-01-22">
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card cyan">
                <div class="stat-value" id="total-chats">2,229</div>
                <div class="stat-label">Total Chats</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-value" id="bot-completed">25%</div>
                <div class="stat-label">Bot Completed</div>
            </div>
            <div class="stat-card green">
                <div class="stat-value" id="agent-resolved">5%</div>
                <div class="stat-label">Agent Resolved</div>
            </div>
            <div class="stat-card yellow">
                <div class="stat-value" id="escalation-rate">10%</div>
                <div class="stat-label">Escalated to Agent</div>
            </div>
            <div class="stat-card red">
                <div class="stat-value" id="abandoned">55%</div>
                <div class="stat-label">Customer Left Bot</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-value" id="connection-failed">11%</div>
                <div class="stat-label">Connection Failed</div>
            </div>
        </div>

        <div id="sankey-chart"></div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #00d4ff;"></div>
                <span>Chat Entry</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #7c3aed;"></div>
                <span>Intent Classification</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f59e0b;"></div>
                <span>Bot/Agent Routing</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #10b981;"></div>
                <span>Positive Outcomes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef4444;"></div>
                <span>Negative Outcomes</span>
            </div>
        </div>

        <div class="insight-box">
            <h3>Bot Containment Insight</h3>
            <p>Only 10% of chats escalate to an agent queue. The chatbot handles 90% of conversations,
               though 55% of customers leave before completion. Bot completion rate is 25%.</p>
        </div>

        <p class="data-note">Data source: Amazon Connect CTR Events | Channel: CHAT</p>

        <footer>
            Chat Flow Sankey Visualization | Generated from BigQuery Data
        </footer>
    </div>

    <script>
        // Sankey data from BigQuery query (2025-01-22)
        const sankeyData = {
            links: [
                // Stage 1: Entry -> Intent
                { source: "Web/App chat", target: "No intent captured", value: 713 },
                { source: "Web/App chat", target: "Bot-resolvable intent", value: 389 },
                { source: "Web/App chat", target: "Other intent", value: 312 },
                { source: "Web/App chat", target: "Billing query", value: 179 },
                { source: "Web/App chat", target: "Sales/Switching", value: 173 },
                { source: "Web/App chat", target: "Fallback intent", value: 164 },
                { source: "Web/App chat", target: "Agent requested", value: 122 },
                { source: "Web/App chat", target: "Complex issue", value: 115 },
                { source: "Reconnection attempt", target: "Bot-resolvable intent", value: 19 },
                { source: "Reconnection attempt", target: "Other intent", value: 17 },
                { source: "Reconnection attempt", target: "Agent requested", value: 9 },
                { source: "Reconnection attempt", target: "Billing query", value: 8 },
                { source: "Reconnection attempt", target: "Complex issue", value: 4 },
                { source: "Reconnection attempt", target: "Fallback intent", value: 3 },
                { source: "Reconnection attempt", target: "Sales/Switching", value: 2 },

                // Stage 2: Intent -> Routing
                { source: "No intent captured", target: "Bot conversation ended", value: 296 },
                { source: "Other intent", target: "Customer left chatbot", value: 247 },
                { source: "No intent captured", target: "Connection failed", value: 240 },
                { source: "Bot-resolvable intent", target: "Customer left chatbot", value: 188 },
                { source: "No intent captured", target: "Customer left chatbot", value: 177 },
                { source: "Sales/Switching", target: "Customer left chatbot", value: 160 },
                { source: "Bot-resolvable intent", target: "Bot conversation ended", value: 156 },
                { source: "Billing query", target: "Customer left chatbot", value: 147 },
                { source: "Fallback intent", target: "Customer left chatbot", value: 124 },
                { source: "Complex issue", target: "Customer left chatbot", value: 96 },
                { source: "Agent requested", target: "Customer left chatbot", value: 81 },
                { source: "Bot-resolvable intent", target: "Escalated to agent queue", value: 64 },
                { source: "Other intent", target: "Escalated to agent queue", value: 49 },
                { source: "Other intent", target: "Bot conversation ended", value: 33 },
                { source: "Agent requested", target: "Escalated to agent queue", value: 31 },
                { source: "Billing query", target: "Escalated to agent queue", value: 26 },
                { source: "Fallback intent", target: "Escalated to agent queue", value: 25 },
                { source: "Agent requested", target: "Bot conversation ended", value: 19 },
                { source: "Fallback intent", target: "Bot conversation ended", value: 18 },
                { source: "Billing query", target: "Bot conversation ended", value: 14 },
                { source: "Complex issue", target: "Escalated to agent queue", value: 12 },
                { source: "Complex issue", target: "Bot conversation ended", value: 11 },
                { source: "Sales/Switching", target: "Bot conversation ended", value: 9 },
                { source: "Sales/Switching", target: "Escalated to agent queue", value: 6 },

                // Stage 3: Routing -> Outcome
                { source: "Customer left chatbot", target: "Customer abandoned bot", value: 1220 },
                { source: "Bot conversation ended", target: "Bot completed", value: 556 },
                { source: "Connection failed", target: "Connection failed", value: 240 },
                { source: "Escalated to agent queue", target: "Agent resolved", value: 122 },
                { source: "Escalated to agent queue", target: "Customer ended with agent", value: 65 },
                { source: "Escalated to agent queue", target: "Abandoned in queue", value: 22 },
                { source: "Escalated to agent queue", target: "Other outcome", value: 4 }
            ]
        };

        // Define node colors
        const nodeColors = {
            // Stage 1: Entry (Cyan)
            "Web/App chat": "#00d4ff",
            "Reconnection attempt": "#0891b2",

            // Stage 2: Intent Classification (Purple shades)
            "No intent captured": "#6b7280",
            "Bot-resolvable intent": "#7c3aed",
            "Fallback intent": "#8b5cf6",
            "Agent requested": "#a855f7",
            "Billing query": "#c084fc",
            "Complex issue": "#d946ef",
            "Sales/Switching": "#e879f9",
            "Other intent": "#9ca3af",

            // Stage 3: Routing (Yellow/Orange)
            "Bot conversation ended": "#f59e0b",
            "Customer left chatbot": "#fb923c",
            "Escalated to agent queue": "#f97316",
            "Connection failed": "#ef4444",

            // Stage 4: Outcomes
            "Bot completed": "#10b981",
            "Agent resolved": "#059669",
            "Customer ended with agent": "#34d399",
            "Customer abandoned bot": "#ef4444",
            "Abandoned in queue": "#dc2626",
            "Other outcome": "#6b7280"
        };

        // Build unique node list
        const nodeSet = new Set();
        sankeyData.links.forEach(l => {
            nodeSet.add(l.source);
            nodeSet.add(l.target);
        });

        const nodeOrder = [
            // Entry
            "Web/App chat", "Reconnection attempt",
            // Intents
            "No intent captured", "Bot-resolvable intent", "Other intent", "Billing query",
            "Sales/Switching", "Fallback intent", "Agent requested", "Complex issue",
            // Routing
            "Bot conversation ended", "Customer left chatbot", "Escalated to agent queue", "Connection failed",
            // Outcomes
            "Bot completed", "Agent resolved", "Customer ended with agent",
            "Customer abandoned bot", "Abandoned in queue", "Other outcome"
        ];

        const nodes = nodeOrder.filter(n => nodeSet.has(n));
        const nodeIndices = {};
        nodes.forEach((node, idx) => {
            nodeIndices[node] = idx;
        });

        // Prepare Plotly data
        const sources = sankeyData.links.map(l => nodeIndices[l.source]);
        const targets = sankeyData.links.map(l => nodeIndices[l.target]);
        const values = sankeyData.links.map(l => l.value);

        const linkColors = sankeyData.links.map(l => {
            const baseColor = nodeColors[l.source] || "#888888";
            return baseColor + "50";
        });

        // Calculate node values
        const totalChats = 2229;
        const nodeValues = {};
        nodes.forEach(n => {
            let val = 0;
            sankeyData.links.forEach(l => {
                if (l.source === n) val += l.value;
            });
            if (val === 0) {
                sankeyData.links.forEach(l => {
                    if (l.target === n) val += l.value;
                });
            }
            nodeValues[n] = val;
        });

        const data = [{
            type: "sankey",
            orientation: "h",
            node: {
                pad: 18,
                thickness: 22,
                line: { color: "rgba(255,255,255,0.3)", width: 1 },
                label: nodes.map(n => {
                    const val = nodeValues[n];
                    const pct = ((val / totalChats) * 100).toFixed(1);
                    return `${n}\n${val.toLocaleString()} (${pct}%)`;
                }),
                color: nodes.map(n => nodeColors[n] || "#888888"),
                hovertemplate: '%{label}<extra></extra>'
            },
            link: {
                source: sources,
                target: targets,
                value: values,
                color: linkColors,
                hovertemplate: '%{source.label} â†’ %{target.label}<br>%{value:,} chats<extra></extra>'
            }
        }];

        const layout = {
            font: {
                family: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
                size: 11,
                color: "#ffffff"
            },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(0,0,0,0)",
            margin: { l: 15, r: 15, t: 15, b: 15 },
            height: 600
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            displaylogo: false
        };

        Plotly.newPlot('sankey-chart', data, layout, config);

        // Update stats
        function updateStats() {
            const total = 2229;
            const botCompleted = 556;
            const agentResolved = 122;
            const escalated = 213;  // Total escalated to queue
            const abandoned = 1220;
            const connectionFailed = 240;

            document.getElementById('total-chats').textContent = total.toLocaleString();
            document.getElementById('bot-completed').textContent = Math.round((botCompleted / total) * 100) + '%';
            document.getElementById('agent-resolved').textContent = Math.round((agentResolved / total) * 100) + '%';
            document.getElementById('escalation-rate').textContent = Math.round((escalated / total) * 100) + '%';
            document.getElementById('abandoned').textContent = Math.round((abandoned / total) * 100) + '%';
            document.getElementById('connection-failed').textContent = Math.round((connectionFailed / total) * 100) + '%';
        }

        updateStats();

        // Date picker handler
        document.getElementById('report-date').addEventListener('change', function(e) {
            console.log('Date changed to:', e.target.value);
            alert('To load data for ' + e.target.value + ', run the SQL query with the new date and update the page.');
        });
    </script>
</body>
</html>
